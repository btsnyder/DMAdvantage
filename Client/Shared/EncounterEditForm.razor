<EditForm Model="@_model" OnValidSubmit="OnValidSubmit">
    <DataAnnotationsValidator />
    <div class="row my-2">
        <div class="form-group col">
            <label>Name</label>
            <InputText @bind-Value="@_model.Name" class="form-control" />
            <ValidationMessage For="@(() => _model.Name)" />
        </div>
    </div>
    <div class="row my-2">
        <div class="col">
            <RadzenTabs TabPosition="TabPosition.Top" RenderMode="TabRenderMode.Client" style="margin-bottom: 10px">
                <Tabs>
                    <RadzenTabsItem Text="Character">
                        <div class="row">
                            <RadzenAutoComplete Data=@_characters TextProperty="Name" LoadData=@OnLoadCharacterData 
                                Change=@(args => OnCharacterChange(args)) Class="col" Style="width: 100%"/>
                        </div>
                        @if (_selectedCharacter != null)
                        {
                            <div class="row mb-2">
                                <div class="col-3">
                                    <label class="row">Name</label>
                                    <b class="fs-5 row">@_selectedCharacter.Name</b>
                                </div>
                                <div class="col">
                                    <label class="row">AC</label>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Warning" Text=@_selectedCharacter.ArmorClass.ToString() class="fs-5 row"/>
                                </div>
                                <div class="col">
                                    <label class="row">HP</label>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text=@_selectedCharacter.HitPoints.ToString() class="fs-5 row"/>
                                </div>
                                <div class="col">
                                    <label class="row">LVL</label>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Info" Text=@_selectedCharacter.Level.ToString() class="fs-5 row"/>
                                </div>
                                <div class="col">
                                    <label class="row">STR</label>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text=@_selectedCharacter.StrengthBonus.ToString() class="fs-5 row"/>
                                </div>
                                <div class="col">
                                    <label class="row">DEX</label>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text=@_selectedCharacter.DexterityBonus.ToString() class="fs-5 row"/>
                                </div>
                                <div class="col">
                                    <label class="row">CON</label>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text=@_selectedCharacter.ConstitutionBonus.ToString() class="fs-5 row"/>
                                </div>
                                <div class="col">
                                    <label class="row">INT</label>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text=@_selectedCharacter.IntelligenceBonus.ToString() class="fs-5 row"/>
                                </div>
                                <div class="col">
                                    <label class="row">WIS</label>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text=@_selectedCharacter.WisdomBonus.ToString() class="fs-5 row"/>
                                </div>
                                <div class="col">
                                    <label class="row">CHA</label>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text=@_selectedCharacter.CharismaBonus.ToString() class="fs-5 row"/>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <RadzenButton Icon="add_box" class="mb-2 btn-success" Text="Insert" Click="@OnAddCharacter" />
                            </div>
                        }
                    </RadzenTabsItem>
                    <RadzenTabsItem Text="Creature">
                        <div class="row">
                            <RadzenAutoComplete Data=@_creatures TextProperty="Name" LoadData=@OnLoadCreatureData 
                                Change=@(args => OnCreatureChange(args)) Class="col" Style="width: 100%"/>
                        </div>
                        @if (_selectedCreature != null)
                        {
                            <div class="row mb-2">
                                <div class="col-3">
                                    <label class="row">Name</label>
                                    <b class="fs-5 row">@_selectedCreature.Name</b>
                                </div>
                                <div class="col">
                                    <label class="row">AC</label>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Warning" Text=@_selectedCreature.ArmorClass.ToString() class="fs-5 row"/>
                                </div>
                                <div class="col">
                                    <label class="row">HP</label>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text=@_selectedCreature.HitPoints.ToString() class="fs-5 row"/>
                                </div>
                                <div class="col">
                                    <label class="row">CR</label>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Info" Text=@_selectedCreature.ChallengeRating.ToString() class="fs-5 row"/>
                                </div>
                                <div class="col">
                                    <label class="row">STR</label>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text=@_selectedCreature.StrengthBonus.ToString() class="fs-5 row"/>
                                </div>
                                <div class="col">
                                    <label class="row">DEX</label>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text=@_selectedCreature.DexterityBonus.ToString() class="fs-5 row"/>
                                </div>
                                <div class="col">
                                    <label class="row">CON</label>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text=@_selectedCreature.ConstitutionBonus.ToString() class="fs-5 row"/>
                                </div>
                                <div class="col">
                                    <label class="row">INT</label>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text=@_selectedCreature.IntelligenceBonus.ToString() class="fs-5 row"/>
                                </div>
                                <div class="col">
                                    <label class="row">WIS</label>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text=@_selectedCreature.WisdomBonus.ToString() class="fs-5 row"/>
                                </div>
                                <div class="col">
                                    <label class="row">CHA</label>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text=@_selectedCreature.CharismaBonus.ToString() class="fs-5 row"/>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <RadzenButton Icon="add_box" class="mb-2 btn-success" Text="Insert" Click="@OnAddCreature" />
                            </div>
                        }
                    </RadzenTabsItem>
                </Tabs>
            </RadzenTabs>
            <div class="d-flex mb-2">
                @if (!_initativeEditing)
                {
                    <RadzenButton Icon="create" Text="Edit Initative" Click=@InitativeEditStart ButtonStyle="ButtonStyle.Light" Style="width: 200px" class="me-2"/>
                }
                else
                {
                    <RadzenButton Icon="close" Text="Close Edit" Click=@InitativeEditDone ButtonStyle="ButtonStyle.Danger" Style="width: 200px" class="me-2"/>
                }
                <RadzenButton Icon="chevron_left" Click=@InitativePrevious ButtonStyle="ButtonStyle.Primary" class="me-2"/>
                <RadzenButton Icon="chevron_right" Click=@InitativeNext ButtonStyle="ButtonStyle.Primary" />
            </div>
            <div class="row mb-2">
                <div class="col">
                    <RadzenDataGrid @ref="_initativeGrid" Data="@_initatives" TItem="InitativeDataModel" @bind-Value="@_selectedInitatives"
                        EditMode="DataGridEditMode.Multiple" RowSelect=OnRowSelect>
                        <Columns>
                            <RadzenDataGridColumn TItem="InitativeDataModel" Width="10%">
                                <Template Context="initative">
                                    @if (_currentPlayer == initative)
                                    {
                                        <RadzenIcon Icon="chevron_right" />
                                    }
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="InitativeDataModel" Property="Initative" Title="Init" Width="12%">
                                <EditTemplate Context="initative">
                                    <RadzenNumeric @bind-Value="initative.Initative" Style="width:100%" />
                                </EditTemplate>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="InitativeDataModel" Property="Name" Title="Name" Width="24%"/>
                            <RadzenDataGridColumn TItem="InitativeDataModel" Property="Player" Title="Class" Width="24%" />
                            <RadzenDataGridColumn TItem="InitativeDataModel" Property="CurrentHP" Title="HP" Width="10%" />
                            <RadzenDataGridColumn TItem="InitativeDataModel" Property="CurrentFP" Title="FP" Width="10%" />
                            <RadzenDataGridColumn TItem="InitativeDataModel" Property="CurrentTP" Title="TP" Width="10%" />
                        </Columns>
                    </RadzenDataGrid>
                </div>
                <div class="col">
                    <RadzenCard>
                        <div class="row mb-2">
                            <div class="col">
                                <text>Name: @_selectedInitative?.Name</text>
                            </div>
                            @if (_selectedInitative?.Being is CharacterResponse character)
                            {
                                <div class="col">
                                    <text>Player: @character.PlayerName</text>
                                </div>
                                <div class="col">
                                    <text>Class: @character.Class</text>
                                </div>
                            }
                        </div>
                        <div class="d-flex mb-2 align-items-center">
                            <div class="me-4">
                                HP: @_selectedInitative?.CurrentHP/@_selectedInitative?.Being?.HitPoints
                            </div>
                            <div class="me-2" style="width: 80px">
                                <RadzenNumeric @bind-Value="_healthEdit" Style="width:100%" />
                            </div>
                            <div class="me-2">
                                <button type="button" class="btn btn-danger" @onclick=@ApplyDamage>
                                    <span class="oi oi-droplet" aria-hidden="true"></span>
                                </button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-success" @onclick=@ApplyHealth>
                                    <span class="oi oi-heart" aria-hidden="true"></span>
                                </button>
                            </div>
                        </div>
                        <div class="d-flex mb-2 justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="me-5">
                                    FP: <b>@_selectedInitative?.CurrentFP/@_selectedInitative?.Being?.ForcePoints</b>
                                </div>
                                <div class="me-2">
                                    <RadzenButton Icon="add" Click=@(() => _selectedInitative.CurrentFP++) ButtonStyle="ButtonStyle.Danger"/>
                                </div>
                                <div>
                                    <RadzenButton Icon="remove" Click=@(() => _selectedInitative.CurrentFP--) ButtonStyle="ButtonStyle.Danger"/>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="me-5">
                                    TP: <b>@_selectedInitative?.CurrentTP/@_selectedInitative?.Being?.TechPoints</b>
                                </div>
                                <div class="me-2">
                                    <RadzenButton Icon="add" Click=@(() => _selectedInitative.CurrentTP++) ButtonStyle="ButtonStyle.Danger"/>
                                </div>
                                <div>
                                    <RadzenButton Icon="remove" Click=@(() => _selectedInitative.CurrentTP--) ButtonStyle="ButtonStyle.Danger"/>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-2 align-items-bottom" style="font-size: x-large">
                            <b>Force Powers</b>
                        </div>
                        <ForcePowerGrid Title="At-Will" Powers=@_selectedForcePowers.Where(x => x.Level == 0).ToList() />
                        <ForcePowerGrid Title="Level 1" Powers=@_selectedForcePowers.Where(x => x.Level == 1).ToList() />
                        <ForcePowerGrid Title="Level 2" Powers=@_selectedForcePowers.Where(x => x.Level == 2).ToList() />
                    </RadzenCard>
                </div>
            </div>
        </div>
    </div>
    <div class="row my-2">
        <button disabled="@_loading" class="btn btn-primary">
            @if (_loading)
            {
                <span class="spinner-border spinner-border-sm mr-1"></span>
            }
            Save
        </button>
        <NavLink href="encounters" class="btn btn-link">Cancel</NavLink>
    </div>
</EditForm>